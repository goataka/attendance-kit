name: Update CDK Snapshots

on:
  workflow_call:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-snapshots:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: infrastructure/deploy/package-lock.json

      - name: Install dependencies
        working-directory: infrastructure/deploy
        run: npm ci

      - name: Build TypeScript
        working-directory: infrastructure/deploy
        run: npm run build

      - name: Update snapshots
        working-directory: infrastructure/deploy
        run: npm test -- -u --testPathIgnorePatterns=test/integration

      - name: Check for snapshot changes
        id: snapshot-changes
        run: |
          if git diff --quiet infrastructure/deploy/test/__snapshots__/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No snapshot changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Snapshot changes detected"
          fi

      - name: Commit and push snapshot updates
        if: steps.snapshot-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add infrastructure/deploy/test/__snapshots__/
          git commit -m "CDKã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è‡ªå‹•æ›´æ–°"
          git push

      - name: Comment on PR
        if: steps.snapshot-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = [
              '## ğŸ“¸ CDKã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆè‡ªå‹•æ›´æ–°',
              '',
              'CDKé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è‡ªå‹•æ›´æ–°ã—ã¾ã—ãŸã€‚',
              '',
              '### æ›´æ–°ã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ',
              '',
              '```',
              'infrastructure/deploy/test/__snapshots__/',
              '```',
              '',
              'å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š',
              '- [æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‚’è¡¨ç¤º](${{ github.event.pull_request.html_url }}/commits)',
              '- [ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å·®åˆ†ã‚’ç¢ºèª](${{ github.event.pull_request.html_url }}/files)',
              '',
              '> âš ï¸ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®å¤‰æ›´ãŒæ„å›³ã—ãŸã‚‚ã®ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            ].join('\n');

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: No changes message
        if: steps.snapshot-changes.outputs.has_changes == 'false'
        run: |
          echo "âœ… ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚¹ãƒˆã¯æ—¢å­˜ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚"
