name: 'Pre-merge CDK Validation'
description: 'CDK検証を実行し、LocalStackでデプロイをテストします'

runs:
  using: "composite"
  steps:
    - name: Setup Node.js 24
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'
        cache-dependency-path: infrastructure/deploy/package-lock.json

    - name: Install dependencies
      working-directory: infrastructure/deploy
      shell: bash
      run: npm ci

    - name: Build TypeScript
      working-directory: infrastructure/deploy
      shell: bash
      run: npm run build

    - name: Run Unit Tests
      working-directory: infrastructure/deploy
      shell: bash
      run: npm run test:unit

    - name: Install CDK CLI
      shell: bash
      run: npm install --global aws-cdk-local aws-cdk

    - name: Start LocalStack
      working-directory: infrastructure/deploy
      shell: bash
      run: npm run localstack:start

    - name: Deploy to LocalStack
      working-directory: infrastructure/deploy
      shell: bash
      run: npm run localstack:deploy
      env:
        AWS_ACCESS_KEY_ID: test
        AWS_SECRET_ACCESS_KEY: test
        AWS_DEFAULT_REGION: ap-northeast-1

    - name: Stop LocalStack
      if: always()
      working-directory: infrastructure/deploy
      shell: bash
      run: npm run localstack:stop

    - name: Comment on PR failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          const comment = `## ❌ CDK検証失敗
          
          詳細: ${context.payload.repository.html_url}/actions/runs/${context.runId}`;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
