name: 'Pre-merge CDK Validation'
description: 'CDK検証を実行し、LocalStackでデプロイをテストします'

runs:
  using: "composite"
  steps:
    - name: Setup Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: infrastructure/deploy/package-lock.json

    - name: Run common tests
      working-directory: infrastructure/deploy
      shell: bash
      run: ./scripts/run-tests.sh

    - name: Run LocalStack validation
      working-directory: infrastructure/deploy
      shell: bash
      run: ./scripts/validate-cdk-localstack.sh

    - name: Comment on PR
      if: success()
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          const comment = [
            '## ✅ CDK Pre-merge Validation Passed',
            '',
            'すべてのCDK検証が成功しました:',
            '',
            '- ✅ TypeScriptビルド成功',
            '- ✅ ユニットテスト通過',
            '- ✅ CDK Synth成功',
            '- ✅ LocalStackへのデプロイ成功',
            '- ✅ DynamoDB統合テスト通過 (jest)',
            '',
            'このPRはマージ可能です。'
          ].join('\n');

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });

    - name: Comment on PR failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          const comment = [
            '## ❌ CDK Pre-merge Validation Failed',
            '',
            'CDK検証中にエラーが発生しました。',
            '',
            '詳細はワークフローログを確認してください:',
            `[ワークフロー実行ログ](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
            '',
            '問題を修正してから再度プッシュしてください。'
          ].join('\n');

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
