# 初期データ投入機能 - 実装プラン

## 概要

開発・テスト環境用の初期データを簡単に投入できる仕組みを提供します。

## 目的

- 開発環境でのデータ準備の効率化
- テスト実行時のサンプルデータ提供
- 新規開発者のオンボーディング支援

## スコープ

### Phase 1（本実装）
- ユーザーデータの定義と参照
- 打刻レコードのサンプルデータ投入
- LocalStack環境対応

### 将来の拡張（Phase 2以降）
- ユーザー管理テーブルの実装
- より多様なサンプルデータパターン
- 本番環境用の初期マスタデータ投入機能

## アーキテクチャ

```
apps/backend/seeds/
├── seed.ts                    # メインスクリプト
├── data/
│   ├── users.json            # ユーザー定義
│   └── clock-records.json    # 打刻レコード
└── README.md                 # 使用方法
```

### データフロー

1. JSONファイルから初期データを読み込み
2. 環境変数からDynamoDB接続情報を取得
3. 既存レコードをチェック（冪等性）
4. DynamoDBに投入

## 技術仕様

### データ構造

#### users.json
```typescript
interface UserData {
  userId: string;
  name: string;
  email: string;
  department: string;
}
```

#### clock-records.json
```typescript
interface ClockRecordSeedData {
  userId: string;
  type: 'clock-in' | 'clock-out';
  location?: string;
  deviceId?: string;
  daysAgo: number;
  hour: number;
  minute: number;
}
```

### 環境変数

| 変数 | 説明 | デフォルト |
|------|------|----------|
| `DYNAMODB_TABLE_NAME` | テーブル名 | `attendance-kit-dev-clock` |
| `DYNAMODB_ENDPOINT` | エンドポイント | なし（AWS） |
| `AWS_REGION` | リージョン | `ap-northeast-1` |

## 実装詳細

### 冪等性の確保

既存レコード数をチェックし、データが存在する場合はスキップします。`--force`オプションで強制的に上書き可能です。

### エラーハンドリング

- DynamoDB接続エラー
- テーブル不存在エラー
- JSONパースエラー

すべて適切なエラーメッセージと共に終了コード1で終了します。

## 使用方法

```bash
# 基本的な実行
npm run seed:local

# 強制上書き
npm run seed:local -- --force
```

## テスト

### 単体テスト
- データファイルのバリデーション
- フィールドの存在確認
- データ整合性チェック

### 統合テスト
LocalStack環境でのE2Eテストは、今後の課題として検討します。

## 制約事項

- 現状、ユーザー認証情報はAuthServiceにハードコードされています
- ユーザー管理テーブルが実装されていないため、ユーザーデータは参考情報のみです
- 本番環境での実行は想定していません

## セキュリティ考慮事項

- シードデータにはテスト用の情報のみを含めます
- 本番環境で使用される認証情報は含めません
- 環境変数経由でデータベース接続情報を管理します

## 運用

### 定期メンテナンス
- サンプルユーザーの追加・更新
- 打刻パターンの多様化
- データ品質の維持

### バージョン管理
- データファイルはGit管理下に置きます
- 変更履歴をコミットログで追跡します

## 将来の改善

1. **ユーザー管理機能の実装**
   - 専用のユーザーテーブル作成
   - パスワードハッシュ化
   - ユーザー属性の拡張

2. **データパターンの拡張**
   - 月間データ生成
   - 複数オフィス対応
   - 特殊ケース（休日出勤、深夜勤務）

3. **CI/CD統合**
   - テスト環境への自動投入
   - スモークテストの一部として実行
