# AWS利用金額アラート - ビジネス要件

## 背景

AWS利用コストの予期せぬ超過を防ぐため、予算管理とアラート通知機能を導入する。

## 目的

- AWS利用額の可視化と管理
- 予算超過の早期検知
- コスト超過の未然防止
- 財務リスクの最小化

## ビジネス要件

### 予算設定

- **予算額**: 1,000円/月
- **対象**: AWSアカウント全体
- **期間**: 月次

**理由**: 小規模プロジェクトのため、最小限の予算で開始し、必要に応じて調整可能にする。

### アラート条件

#### 実利用額アラート

- **条件**: 月次利用額が1,000円を超過した時点
- **優先度**: 高（P1）
- **対応**: 即座に対処が必要

**理由**: 予算超過が発生した場合、追加コストが発生し続けるため、緊急対応が必要。

#### 予測額アラート

- **条件**: 月末までの予測利用額が1,000円を超える見込みの場合
- **優先度**: 高（P1）
- **対応**: 事前に対策を講じる

**理由**: 実際の超過前に対策を講じることで、予算超過を未然に防ぐことができる。

### 通知方法

- **配信先**: スマホ（メール受信）
- **プロトコル**: Email
- **受信者**: プロジェクト管理者

**理由**: 
- 即座に通知を受け取れる
- 追加コストなし（SNS Email通知は無料枠内）
- スマホで確認可能

### 運用要件

#### デプロイ

- **頻度**: 初回のみ（アカウントスタック）
- **方法**: AWS CDK
- **実行者**: インフラ管理者

#### モニタリング

- **頻度**: 必要時
- **ツール**: AWS Budgetコンソール
- **確認項目**: 
  - 予算進捗
  - アラート履歴
  - 予測額

#### 対応手順

##### 予測額アラート受信時

1. AWS Cost Explorerでコスト内訳を確認
2. 不要なリソースがないか確認
3. 必要に応じてリソース削除または停止
4. 予算超過の可能性が高い場合は関係者に報告

##### 実利用額アラート受信時

1. 即座にAWS Cost Explorerでコスト内訳を確認
2. 予期せぬ課金がないか確認
3. 緊急でないリソースを停止
4. 関係者に状況を報告
5. 追加予算の検討または機能縮小の判断

## 成功基準

### 機能面

- ✅ 実利用額が予算を超えた際に5分以内に通知が届く
- ✅ 予測額が予算を超える見込みの際に5分以内に通知が届く
- ✅ 通知成功率が95%以上

### コスト面

- ✅ アラート機能自体の追加コストが発生しない（無料枠内）
- ✅ 予算超過による追加コストを最小限に抑える

### 運用面

- ✅ デプロイが10分以内に完了する
- ✅ 通知設定の変更が5分以内に反映される
- ✅ アラート履歴が確認できる

## ユーザーシナリオ

### シナリオ1: 予測額アラートによる予防

**状況**: 開発中に新しいサービスを追加し、月半ばで予測額が1,000円を超える見込み

**アクション**:
1. 予測額アラートメールをスマホで受信
2. AWS Cost Explorerで詳細を確認
3. 新しいサービスが原因と判明
4. テスト用リソースを削除して予算内に収める

**結果**: 実際の予算超過を回避し、追加コストが発生しない

### シナリオ2: 実利用額アラートによる即時対応

**状況**: 予期せぬトラフィック増加により、月末前に予算を超過

**アクション**:
1. 実利用額アラートメールをスマホで受信
2. AWS Cost Explorerで原因を特定
3. 不要なログ出力を停止
4. CloudFrontキャッシュ設定を最適化
5. 関係者に報告し、追加予算を申請

**結果**: 追加コストを最小限に抑え、サービス継続が可能

### シナリオ3: 定期的な予算確認

**状況**: 月初に前月のコストを確認

**アクション**:
1. AWS Budgetコンソールで前月の実績を確認
2. Cost Explorerでサービス別コストを分析
3. 今月の予算計画を更新

**結果**: 継続的なコスト最適化が可能

## 制約事項

### ビジネス制約

- **予算**: 最小限（1,000円/月）
- **人員**: 兼任管理者のみ
- **時間**: 初期セットアップに1時間以内

### 技術制約

- **通知遅延**: AWS Budgetの処理時間により、最大5分程度の遅延が発生する可能性
- **予測精度**: AWS Budgetの予測は過去の使用パターンに基づくため、突発的な増加は検知できない
- **通知方式**: Email通知のみ（Mobile Push は将来対応）

## リスクと対策

### リスク1: 通知が届かない

**影響**: 予算超過に気づかず、追加コストが発生

**対策**: 
- SNSサブスクリプションの確認状態を定期的にチェック
- 複数の通知先を設定（将来対応）

### リスク2: 予算超過が頻発

**影響**: アラート疲れにより、重要な通知を見逃す可能性

**対策**:
- 予算額の見直し
- コスト最適化の実施
- 不要なリソースの定期的な削除

### リスク3: 予測精度の低下

**影響**: 実際の超過前に対策が取れない

**対策**:
- Cost Explorerで定期的に実績を確認
- 大きな変更を加える前にコスト影響を評価

## 将来の拡張

### Phase 2（優先度: 中）

- **詳細レポート**: 週次でコストサマリーをメール配信
- **複数通知先**: 管理者複数名に通知
- **カスタム閾値**: 80%、90%など段階的なアラート

### Phase 3（優先度: 低）

- **Mobile Push通知**: AWS SNS Mobile Push対応
- **Slack通知**: Slack連携でチーム共有
- **ダッシュボード**: コスト推移の可視化

### Phase 4（優先度: 低）

- **自動対応**: 予算超過時に自動的に非本番環境を停止
- **コスト分析**: AI/MLによるコスト異常検知
- **最適化提案**: 自動的なコスト削減提案

## 承認

- **作成日**: 2025-12-31
- **承認者**: プロジェクトオーナー
- **ステータス**: 確定
- **バージョン**: 1.0
