# 打刻画面テスト方針

## テスト概要

打刻画面（ClockInOutPage）の品質を保証するための包括的なテスト戦略を定義します。

## テストレベル

### 1. 単体テスト（Unit Tests）

#### テストフレームワーク
- **ツール**: Vitest 2.1.8 + React Testing Library 16.1.0
- **実行コマンド**: `npm test`
- **ファイル**: `ClockInOutPage.test.tsx`

#### テストケース（5テスト）

##### 1. レンダリングテスト
- **テスト名**: `renders the clock in/out page`
- **目的**: コンポーネントの基本要素が正しく表示されることを確認
- **検証項目**:
  - ページタイトル「勤怠打刻」の表示
  - User IDラベルとフィールドの存在
  - Passwordラベルとフィールドの存在
  - 出勤ボタンの存在
  - 退勤ボタンの存在
- **重要度**: 🔴 必須

##### 2. 未入力バリデーションテスト
- **テスト名**: `shows error when fields are empty`
- **目的**: 未入力時のバリデーションが正常に動作することを確認
- **手順**:
  1. フィールドを空のままにする
  2. 出勤ボタンをクリック
- **期待結果**: "User ID and password are required"エラーメッセージ表示
- **重要度**: 🔴 必須

##### 3. 打刻成功テスト
- **テスト名**: `handles successful clock in`
- **目的**: 正常な打刻フローが動作することを確認
- **手順**:
  1. User IDに"user001"を入力
  2. Passwordに"password123"を入力
  3. 出勤ボタンをクリック
- **モック設定**: `mockApi.clockInOut`が成功レスポンスを返す
- **期待結果**: "Clock in successful at [日時]"メッセージ表示
- **重要度**: 🔴 必須

##### 4. 打刻失敗テスト
- **テスト名**: `handles failed clock in`
- **目的**: 認証エラー時の処理が正常に動作することを確認
- **手順**:
  1. 誤ったUser IDとPasswordを入力
  2. 出勤ボタンをクリック
- **モック設定**: `mockApi.clockInOut`が失敗レスポンスを返す
- **期待結果**: "Invalid credentials"エラーメッセージ表示
- **重要度**: 🔴 必須

##### 5. パスワードクリアテスト
- **テスト名**: `clears password after successful clock in`
- **目的**: セキュリティ要件（成功後にパスワードクリア）を確認
- **手順**:
  1. 有効な認証情報を入力
  2. 打刻を実行
- **期待結果**:
  - パスワードフィールドが空になる
  - User IDフィールドは保持される
- **重要度**: 🟡 推奨

#### テストカバレッジ目標
- **行カバレッジ**: 90%以上
- **分岐カバレッジ**: 85%以上
- **関数カバレッジ**: 100%

### 2. E2Eテスト（End-to-End Tests）

#### テストフレームワーク
- **ツール**: Playwright 1.48.0
- **実行コマンド**: `npm run test:e2e`
- **ファイル**: `../../e2e/clock-in-out.spec.ts`

#### テストケース（4テスト）

##### 1. フォーム表示確認テスト
- **テスト名**: `should display clock in/out form`
- **目的**: 実際のブラウザで画面が正しく表示されることを確認
- **検証項目**:
  - ページタイトル
  - 入力フィールド
  - ボタン
  - ビジュアルリグレッション（スクリーンショット比較）
- **重要度**: 🔴 必須

##### 2. 打刻成功フローテスト
- **テスト名**: `should handle clock in`
- **目的**: ユーザーの実際の操作フローをエンドツーエンドで検証
- **手順**:
  1. User ID入力
  2. Password入力
  3. 出勤ボタンクリック
  4. 成功メッセージ確認
- **重要度**: 🔴 必須

##### 3. エラーハンドリングテスト
- **テスト名**: `should show error for empty fields`
- **目的**: 未入力時のエラー表示を実ブラウザで検証
- **期待結果**: エラーメッセージの表示とスタイル適用
- **重要度**: 🔴 必須

##### 4. ナビゲーションテスト
- **テスト名**: `should navigate to records list`
- **目的**: ページ遷移が正常に動作することを確認
- **手順**:
  1. "打刻一覧を見る"リンクをクリック
  2. `/records`ページに遷移
  3. 打刻一覧画面のタイトル確認
- **重要度**: 🔴 必須

#### ビジュアルリグレッションテスト
- **実行コマンド**: `npm run test:visual`
- **スクリーンショット保存先**: `e2e/clock-in-out.spec.ts-snapshots/`
- **比較対象**: `clock-in-out-page.png`
- **許容差分**: ピクセル単位で0（完全一致）

### 3. Storybookストーリー

#### ツール
- **Storybook**: 8.4.7
- **実行コマンド**: `npm run storybook`
- **ファイル**: `ClockInOutPage.stories.tsx`

#### ストーリー（2ストーリー）

##### 1. Default
- **目的**: 初期状態の表示確認
- **状態**: 空フォーム、ボタン有効

##### 2. WithHelperText
- **目的**: ヘルプテキスト表示の確認
- **状態**: テストアカウント情報表示

## テスト実行方針

### 開発時
- **頻度**: コード変更の都度
- **対象**: 単体テスト（Vitest）
- **コマンド**: `npm run test:watch`

### コミット前
- **必須実行**:
  - `npm run lint` - Lintチェック
  - `npm test` - 全単体テスト
  - `npm run build` - ビルドチェック
- **推奨実行**:
  - `npm run test:e2e` - E2Eテスト

### プルリクエスト時
- **CI実行**:
  - 全単体テスト
  - Lintチェック
  - ビルド確認
- **手動確認**:
  - ビジュアルリグレッションテスト
  - Storybook表示確認

## モック戦略

### APIモック
- **ツール**: Vitest `vi.mock()`
- **モック対象**: `../shared/api/mockApi`
- **モック方法**: 関数単位でモック

#### モックパターン

##### 成功レスポンス
```typescript
vi.mocked(mockApi.clockInOut).mockResolvedValue({
  success: true,
  record: {
    id: '1',
    userId: 'user001',
    timestamp: new Date().toISOString(),
    type: 'clock-in'
  }
});
```

##### 失敗レスポンス
```typescript
vi.mocked(mockApi.clockInOut).mockResolvedValue({
  success: false,
  message: 'Invalid credentials'
});
```

### ルーターモック
- **ツール**: React Router `BrowserRouter`
- **ラッパー**: `renderWithRouter` ヘルパー関数
- **目的**: Link コンポーネントのテスト

## テストデータ

### 正常系テストデータ
- **ユーザーID**: "user001"
- **パスワード**: "password123"
- **期待打刻タイプ**: "clock-in" または "clock-out"

### 異常系テストデータ
- **無効なユーザーID**: "wronguser"
- **無効なパスワード**: "wrongpass"
- **空フィールド**: ""（空文字）

## テスト保守方針

### スナップショット更新
- **コマンド**: `npm test -- -u`
- **タイミング**: 意図的なUI変更時のみ
- **レビュー**: 差分を必ず確認してから更新

### テスト追加基準
- 新機能追加時
- バグ修正時（リグレッション防止）
- 重要なエッジケース発見時

### テスト削除基準
- 機能削除時
- 重複テスト発見時

## 既知の制限事項

1. **モックAPIの制限**: 実際のネットワーク遅延やタイムアウトをシミュレートしない
2. **ブラウザ互換性**: Playwrightはchromiumのみでテスト実行
3. **アクセシビリティ**: 自動テストは未実装（手動確認が必要）

## 今後の改善予定

- [ ] アクセシビリティテストの追加
- [ ] パフォーマンステストの追加
- [ ] クロスブラウザテストの実装
- [ ] ネットワーク遅延シミュレーション
- [ ] テストカバレッジレポートの自動生成
