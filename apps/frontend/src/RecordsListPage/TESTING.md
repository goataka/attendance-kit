# 打刻一覧画面テスト方針

## テスト概要

打刻一覧画面（RecordsListPage）の品質を保証するための包括的なテスト戦略を定義します。

## テストレベル

### 1. 単体テスト（Unit Tests）

#### テストフレームワーク
- **ツール**: Vitest 2.1.8 + React Testing Library 16.1.0
- **実行コマンド**: `npm test`
- **ファイル**: `RecordsListPage.test.tsx`

#### テストケース（7テスト）

##### 1. レンダリングテスト
- **テスト名**: `renders the records list page`
- **目的**: ページの基本構造が正しく表示されることを確認
- **検証項目**:
  - ページタイトル「打刻一覧」の表示
  - テーブル構造の存在
  - データ行の表示
- **重要度**: 🔴 必須

##### 2. ローディング状態テスト
- **テスト名**: `displays loading state initially`
- **目的**: データ取得中のUI状態を確認
- **検証項目**: "Loading..."メッセージの表示
- **重要度**: 🟡 推奨

##### 3. データ表示テスト
- **テスト名**: `displays records after loading`
- **目的**: 取得したデータが正しくテーブルに表示されることを確認
- **検証項目**:
  - レコードID表示
  - ユーザーID表示
  - 打刻種別バッジ表示
- **重要度**: 🔴 必須

##### 4. データなしテスト
- **テスト名**: `displays no data message when records are empty`
- **目的**: データが0件の場合の表示を確認
- **検証項目**: "打刻データがありません"メッセージ表示
- **重要度**: 🔴 必須

##### 5. ユーザーIDフィルタリングテスト
- **テスト名**: `filters records by user ID`
- **目的**: ユーザーID検索が正常に動作することを確認
- **手順**:
  1. User IDフィールドに"user002"を入力
  2. 検索ボタンをクリック
- **検証**: APIが正しいフィルター条件で呼ばれること
- **重要度**: 🔴 必須

##### 6. 種別フィルタリングテスト
- **テスト名**: `filters records by type`
- **目的**: 打刻種別フィルターが正常に動作することを確認
- **手順**:
  1. 種別セレクトで"clock-in"を選択
  2. 検索ボタンをクリック
- **検証**: APIが type='clock-in' でフィルタされること
- **重要度**: 🔴 必須

##### 7. リセット機能テスト
- **テスト名**: `resets filters`
- **目的**: リセットボタンが全フィルターをクリアすることを確認
- **手順**:
  1. 複数のフィルター条件を設定
  2. リセットボタンをクリック
- **検証**:
  - User IDフィールドが空
  - 種別セレクトが"all"
- **重要度**: 🔴 必須

#### テストカバレッジ目標
- **行カバレッジ**: 90%以上
- **分岐カバレッジ**: 85%以上
- **関数カバレッジ**: 100%

### 2. E2Eテスト（End-to-End Tests）

#### テストフレームワーク
- **ツール**: Playwright 1.48.0
- **実行コマンド**: `npm run test:e2e`
- **ファイル**: `../../e2e/records-list.spec.ts`

#### テストケース（4テスト）

##### 1. 一覧表示確認テスト
- **テスト名**: `should display records list`
- **目的**: 実際のブラウザで一覧画面が正しく表示されることを確認
- **検証項目**:
  - ページタイトル
  - フィルターフィールド
  - テーブル構造
  - ビジュアルリグレッション（スクリーンショット比較）
- **重要度**: 🔴 必須

##### 2. フィルタリング動作テスト
- **テスト名**: `should filter records by user ID`
- **目的**: ユーザーの実際のフィルター操作を検証
- **手順**:
  1. User IDフィールドに"user001"を入力
  2. 検索ボタンをクリック
  3. フィルタリング結果を確認
- **期待結果**: user001のレコードのみ表示
- **重要度**: 🔴 必須

##### 3. リセット動作テスト
- **テスト名**: `should reset filters`
- **目的**: リセット機能がUIレベルで正常に動作することを確認
- **手順**:
  1. フィルター条件を設定
  2. リセットボタンをクリック
  3. フィールド値を確認
- **期待結果**: 全フィールドが初期状態に戻る
- **重要度**: 🔴 必須

##### 4. ナビゲーションテスト
- **テスト名**: `should navigate back to clock in page`
- **目的**: ページ遷移が正常に動作することを確認
- **手順**:
  1. "打刻画面に戻る"リンクをクリック
  2. `/`ページに遷移
  3. 打刻画面のタイトル確認
- **重要度**: 🔴 必須

#### ビジュアルリグレッションテスト
- **実行コマンド**: `npm run test:visual`
- **スクリーンショット保存先**: `e2e/records-list.spec.ts-snapshots/`
- **比較対象**: `records-list-page.png`
- **許容差分**: ピクセル単位で0（完全一致）

### 3. Storybookストーリー

#### ツール
- **Storybook**: 8.4.7
- **実行コマンド**: `npm run storybook`
- **ファイル**: `RecordsListPage.stories.tsx`

#### ストーリー（2ストーリー）

##### 1. Default
- **目的**: 初期状態の表示確認
- **状態**: データロード後の一覧表示

##### 2. WithFilters
- **目的**: フィルター機能の表示確認
- **状態**: フィルター条件入力可能状態

## テスト実行方針

### 開発時
- **頻度**: コード変更の都度
- **対象**: 単体テスト（Vitest）
- **コマンド**: `npm run test:watch`

### コミット前
- **必須実行**:
  - `npm run lint` - Lintチェック
  - `npm test` - 全単体テスト
  - `npm run build` - ビルドチェック
- **推奨実行**:
  - `npm run test:e2e` - E2Eテスト

### プルリクエスト時
- **CI実行**:
  - 全単体テスト
  - Lintチェック
  - ビルド確認
- **手動確認**:
  - ビジュアルリグレッションテスト
  - Storybook表示確認

## モック戦略

### APIモック
- **ツール**: Vitest `vi.mock()`
- **モック対象**: `../shared/api/mockApi`
- **モック方法**: `getRecords`関数をモック

#### モックパターン

##### 正常系（データあり）
```typescript
const mockRecords = [
  {
    id: '1',
    userId: 'user001',
    timestamp: '2026-01-10T09:00:00Z',
    type: 'clock-in' as const,
  },
  {
    id: '2',
    userId: 'user001',
    timestamp: '2026-01-10T18:00:00Z',
    type: 'clock-out' as const,
  },
];

vi.mocked(mockApi.getRecords).mockResolvedValue(mockRecords);
```

##### データなし
```typescript
vi.mocked(mockApi.getRecords).mockResolvedValue([]);
```

##### ローディング状態
```typescript
vi.mocked(mockApi.getRecords).mockImplementation(
  () => new Promise(() => {}) // 永遠に解決しないPromise
);
```

### ルーターモック
- **ツール**: React Router `BrowserRouter`
- **ラッパー**: `renderWithRouter` ヘルパー関数
- **目的**: Link コンポーネントのテスト

## テストデータ

### 正常系テストデータ
```typescript
const testRecords = [
  {
    id: '1',
    userId: 'user001',
    timestamp: '2026-01-10T09:00:00Z',
    type: 'clock-in',
  },
  {
    id: '2',
    userId: 'user001',
    timestamp: '2026-01-10T18:00:00Z',
    type: 'clock-out',
  },
];
```

### フィルター条件テストデータ
- **ユーザーID**: "user001", "user002"
- **打刻種別**: "all", "clock-in", "clock-out"
- **日時範囲**: ISO 8601形式の日時文字列

## テスト保守方針

### スナップショット更新
- **コマンド**: `npm test -- -u`
- **タイミング**: 意図的なUI変更時のみ
- **レビュー**: 差分を必ず確認してから更新

### テスト追加基準
- 新機能追加時（ソート、ページネーション等）
- バグ修正時（リグレッション防止）
- 複雑なフィルター条件追加時

### テスト削除基準
- 機能削除時
- 重複テスト発見時

## 特殊なテストケース

### 境界値テスト
1. **0件のデータ**: 空配列の処理
2. **大量データ**: パフォーマンステスト（将来実装予定）
3. **日時境界**: 開始/終了日時が同じ場合

### エッジケース
1. **特殊文字**: ユーザーIDに特殊文字が含まれる場合
2. **長いユーザーID**: 表示レイアウト崩れの確認
3. **タイムゾーン**: 日時表示のロケール処理

## 既知の制限事項

1. **モックAPIの制限**: 実際のサーバーサイドフィルタリングをシミュレートしない
2. **ページネーション未実装**: 大量データの処理テストなし
3. **ソート機能未実装**: カラムソートのテストなし

## 今後の改善予定

- [ ] ページネーションテストの追加
- [ ] ソート機能テストの追加
- [ ] パフォーマンステストの追加
- [ ] アクセシビリティテストの追加
- [ ] 日時範囲フィルターの詳細テスト
- [ ] テストカバレッジレポートの自動生成
