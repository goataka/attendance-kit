name: 'Start Agent Task on Deploy Failure'
description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã«Copilot Agentã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã€å…ƒã®PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹'

inputs:
  workflow-name:
    description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å'
    required: true
  failure-message:
    description: 'å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
    required: true
  github-token:
    description: 'GitHub token'
    required: true

runs:
  using: "composite"
  steps:
    - name: Start Copilot Agent Task on failure
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
      run: |
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±ã‚’å–å¾—
        WORKFLOW_NAME="${{ inputs.workflow-name }}"
        FAILURE_MESSAGE="${{ inputs.failure-message }}"
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        COMMIT_SHA="${{ github.sha }}"
        COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${COMMIT_SHA}"
        BRANCH="${{ github.ref }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã®èª¬æ˜ã‚’ä½œæˆ
        TASK_DESCRIPTION="## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
        
        **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${WORKFLOW_NAME}
        **ã‚¨ãƒ©ãƒ¼å†…å®¹**: ${FAILURE_MESSAGE}
        
        ### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±
        - **å®Ÿè¡Œãƒ­ã‚°**: [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ #${{ github.run_number }}](${RUN_URL})
        - **ã‚³ãƒŸãƒƒãƒˆ**: [${COMMIT_SHA:0:7}](${COMMIT_URL})
        - **ãƒ–ãƒ©ãƒ³ãƒ**: ${BRANCH}
        - **å¤±æ•—æ—¥æ™‚**: ${TIMESTAMP}
        
        ### ä¾é ¼å†…å®¹
        ä¸Šè¨˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚workflow-error-handlerã‚¹ã‚­ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€ä»¥ä¸‹ã®å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
        
        1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã€ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’æŠŠæ¡
        2. ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šï¼ˆä¾å­˜é–¢ä¿‚ã€ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ç’°å¢ƒè¨­å®šãªã©ï¼‰
        3. å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚¨ãƒ©ãƒ¼ã‚’å†ç¾
        4. å•é¡Œã‚’ä¿®æ­£ã—ã€ä¿®æ­£å†…å®¹ã‚’æ¤œè¨¼
        5. ä¿®æ­£å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã€çµæœã‚’å ±å‘Š
        
        **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼URL**: ${RUN_URL}"
        
        echo "Creating Copilot Agent Task..."
        echo "${TASK_DESCRIPTION}"
        
        # gh agent-task createã‚³ãƒãƒ³ãƒ‰ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
        AGENT_OUTPUT=$(echo "${TASK_DESCRIPTION}" | gh agent-task create -F - --repo ${{ github.repository }} 2>&1)
        AGENT_EXIT_CODE=$?
        
        echo "Agent task creation output:"
        echo "${AGENT_OUTPUT}"
        
        if [ ${AGENT_EXIT_CODE} -eq 0 ]; then
          echo "âœ… Copilot Agent TaskãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ"
          
          # ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¹ã‚¯ã®URLã‚’æŠ½å‡ºï¼ˆGitHub CLIã®å‡ºåŠ›ã‹ã‚‰ï¼‰
          AGENT_TASK_URL=$(echo "${AGENT_OUTPUT}" | grep -oP 'https://github\.com/[^\s]+' | head -1)
          
          if [ -n "${AGENT_TASK_URL}" ]; then
            echo "Agent Task URL: ${AGENT_TASK_URL}"
            echo "agent-task-url=${AGENT_TASK_URL}" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ Copilot Agent Taskã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          echo "Exit code: ${AGENT_EXIT_CODE}"
          exit 1
        fi
    
    - name: Comment on PR with Agent Task
      uses: actions/github-script@v7
      if: success()
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const commitSha = context.sha;
          let prNumber = null;
          
          // context.payloadã‹ã‚‰PRç•ªå·ã‚’å–å¾—ï¼ˆpush eventã®å ´åˆã€head_commitã«å«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰
          if (context.payload.head_commit && context.payload.head_commit.message) {
            const prMatch = context.payload.head_commit.message.match(/#(\d+)/);
            if (prMatch) {
              prNumber = parseInt(prMatch[1]);
              console.log(`Found PR number from commit message: #${prNumber}`);
            }
          }
          
          // PRãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã‚³ãƒŸãƒƒãƒˆã«é–¢é€£ã™ã‚‹PRã‚’æ¤œç´¢
          if (!prNumber) {
            try {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commitSha
              });
              
              if (prs.data.length > 0) {
                // ãƒãƒ¼ã‚¸ã•ã‚ŒãŸPRã‚’å„ªå…ˆçš„ã«é¸æŠ
                const mergedPr = prs.data.find(pr => pr.merged_at);
                prNumber = mergedPr ? mergedPr.number : prs.data[0].number;
                console.log(`Found PR number from commit: #${prNumber}`);
              }
            } catch (error) {
              console.log('No PR found for this commit');
            }
          }
          
          // PRãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          if (prNumber) {
            const workflowName = '${{ inputs.workflow-name }}';
            const agentTaskUrl = process.env.AGENT_TASK_URL || '';
            
            let prComment = `## ğŸ¤– Copilot Agent ã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
          
            ã“ã®PRã«é–¢é€£ã™ã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ**${workflowName}**ï¼‰ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
            Copilot AgentãŒã‚¨ãƒ©ãƒ¼å¯¾å¿œã‚¿ã‚¹ã‚¯ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚`;
            
            if (agentTaskUrl) {
              prComment += `\n\nğŸ”— **Agent Task**: ${agentTaskUrl}`;
            }
            
            prComment += `\n\nã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼ã‚’åˆ†æã—ã€ä¿®æ­£ã‚’è©¦ã¿ã¾ã™ã€‚`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: prComment
            });
            
            console.log(`Added comment to PR #${prNumber}`);
          }
