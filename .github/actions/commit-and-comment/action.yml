name: 'Commit and Comment'
description: '変更をコミットし、PRにコメントを投稿する再利用可能なアクション'

inputs:
  files:
    description: 'コミット対象のファイルパス'
    required: true
  commit-message:
    description: 'コミットメッセージ'
    required: true
  pr-comment:
    description: 'PRに投稿するコメント（変更がある場合のみ）'
    required: true
  github-token:
    description: 'GitHub token'
    required: true

runs:
  using: "composite"
  steps:
    - name: Check for changes
      id: check-changes
      shell: bash
      run: |
        if git diff --quiet ${{ inputs.files }}; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
        fi

    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      shell: bash
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add ${{ inputs.files }}
        git commit -m "${{ inputs.commit-message }}"
        git push

    - name: Comment on PR
      if: steps.check-changes.outputs.has_changes == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const commits = await github.rest.repos.listCommits({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.sha,
            per_page: 1
          });
          const commitUrl = commits.data[0].html_url;
          const commitSha = commits.data[0].sha.substring(0, 7);
          
          const comment = `${{ inputs.pr-comment }}\n\n変更: [${commitSha}](${commitUrl})`;

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: comment
          });
