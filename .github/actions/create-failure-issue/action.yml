name: 'Create Issue on Deploy Failure'
description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—æ™‚ã«Issueã‚’ä½œæˆã—ã€å…ƒã®PRãŒã‚ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹'

inputs:
  workflow-name:
    description: 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å'
    required: true
  failure-message:
    description: 'å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸'
    required: true
  github-token:
    description: 'GitHub token'
    required: true

runs:
  using: "composite"
  steps:
    - name: Create Issue on failure
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const workflowName = '${{ inputs.workflow-name }}';
          const failureMessage = '${{ inputs.failure-message }}';
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          const commitSha = context.sha;
          const commitUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/commit/${commitSha}`;
          
          // Issueæœ¬æ–‡ã‚’ä½œæˆ
          const issueBody = `## ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®è©³ç´°
          
          ${failureMessage}
          
          ### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æƒ…å ±
          - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${workflowName}
          - **å®Ÿè¡Œãƒ­ã‚°**: [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ #${context.runNumber}](${runUrl})
          - **ã‚³ãƒŸãƒƒãƒˆ**: [${commitSha.substring(0, 7)}](${commitUrl})
          - **ãƒ–ãƒ©ãƒ³ãƒ**: ${context.ref}
          - **å¤±æ•—æ—¥æ™‚**: ${new Date().toISOString()}
          
          ### å¯¾å¿œãŒå¿…è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          1. å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®š
          2. å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¤œè¨
          3. ä¿®æ­£å¾Œã«å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
          `;
          
          // Issueã‚’ä½œæˆ
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—: ${workflowName}`,
            body: issueBody,
            labels: ['deploy-failure', 'bug']
          });
          
          console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
          
          // å…ƒã®PRã‚’æ¢ã™
          let prNumber = null;
          
          // context.payloadã‹ã‚‰PRç•ªå·ã‚’å–å¾—ï¼ˆpush eventã®å ´åˆã€head_commitã«å«ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ï¼‰
          if (context.payload.head_commit && context.payload.head_commit.message) {
            const prMatch = context.payload.head_commit.message.match(/#(\d+)/);
            if (prMatch) {
              prNumber = parseInt(prMatch[1]);
              console.log(`Found PR number from commit message: #${prNumber}`);
            }
          }
          
          // PRãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€ã‚³ãƒŸãƒƒãƒˆã«é–¢é€£ã™ã‚‹PRã‚’æ¤œç´¢
          if (!prNumber) {
            try {
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commitSha
              });
              
              if (prs.data.length > 0) {
                // ãƒãƒ¼ã‚¸ã•ã‚ŒãŸPRã‚’å„ªå…ˆçš„ã«é¸æŠ
                const mergedPr = prs.data.find(pr => pr.merged_at);
                prNumber = mergedPr ? mergedPr.number : prs.data[0].number;
                console.log(`Found PR number from commit: #${prNumber}`);
              }
            } catch (error) {
              console.log('No PR found for this commit');
            }
          }
          
          // PRãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          if (prNumber) {
            const prComment = `## âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
          
            ã“ã®PRã«é–¢é€£ã™ã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ**${workflowName}**ï¼‰ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚
            
            ğŸ“‹ **Issue**: #${issue.data.number}
            ğŸ”— **è©³ç´°**: ${issue.data.html_url}
            
            å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: prComment
            });
            
            console.log(`Added comment to PR #${prNumber}`);
          }
          
          // Issueã®ç•ªå·ã‚’å‡ºåŠ›ã«è¨­å®šï¼ˆå¾Œç¶šã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨å¯èƒ½ï¼‰
          core.setOutput('issue-number', issue.data.number);
          core.setOutput('issue-url', issue.data.html_url);
