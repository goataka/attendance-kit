name: Deploy Environment Stack to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '!apps/website/**'
      - 'infrastructure/deploy/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-environment-stack.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

permissions:
  id-token: write   # OIDC認証に必要
  contents: read
  pull-requests: write  # PRコメントに必要
  issues: write  # Issue作成に必要

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    outputs:
      cloudfront_url: ${{ steps.deploy-outputs.outputs.cloudfront_url }}
      api_url: ${{ steps.deploy-outputs.outputs.api_url }}
      environment: ${{ steps.deploy-outputs.outputs.environment }}
    
    steps:
      - name: コードのチェックアウト
        uses: actions/checkout@v4

      - name: Node.js 24のセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: 依存関係のインストール
        run: npm run setup

      - name: 全ワークスペースのビルド
        run: npm run build --workspaces --if-present

      - name: AWS認証情報の設定（OIDC経由）
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: CDK Bootstrapの実行
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Running CDK bootstrap (idempotent operation)..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          npx cdk bootstrap aws://${ACCOUNT_ID}/ap-northeast-1 --context stack=environment

      - name: CDK Deploy環境スタック
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/')-Stack"
          echo "Deploying environment stack: ${STACK_NAME}"
          npx cdk deploy ${STACK_NAME} --require-approval never \
            --context stack=environment \
            --context environment=${ENVIRONMENT}

      - name: デプロイ結果の出力
        id: deploy-outputs
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
        run: |
          echo "Deployment completed successfully for environment: ${ENVIRONMENT}"
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/')-Stack"
          
          # スタック出力を一度だけ取得
          STACK_OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs' \
            --output json)
          
          echo "Stack outputs:"
          echo "${STACK_OUTPUTS}" | jq -r '.[] | "\(.OutputKey): \(.OutputValue)"'
          
          # jqで必要な値を抽出（CDKがConstructで生成するサフィックス付きのキー名に対応）
          CLOUDFRONT_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("CloudFrontUrl")) | .OutputValue')
          API_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("ApiUrl")) | .OutputValue')
          
          # 必須のスタック出力が存在しない場合はエラー終了
          if [ -z "${CLOUDFRONT_URL}" ] || [ -z "${API_URL}" ]; then
            echo "Error: Required stack outputs not found"
            echo "CLOUDFRONT_URL: ${CLOUDFRONT_URL}"
            echo "API_URL: ${API_URL}"
            exit 1
          fi
          
          echo "cloudfront_url=${CLOUDFRONT_URL}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

      - name: 失敗時のコメント
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Deploy Environment Stack'
          failure-message: '環境スタックのデプロイに失敗しました。ログを確認してください。'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 失敗時のIssue作成
        if: failure()
        uses: ./.github/actions/create-issue-on-failure
        with:
          workflow-name: 'Deploy Environment Stack'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  e2e-test:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.environment == 'dev'
    environment: dev
    
    steps:
      - name: コードのチェックアウト
        uses: actions/checkout@v4

      - name: Node.js 24のセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: 依存関係のインストール
        run: npm run setup

      - name: Playwrightブラウザのインストール
        run: npx playwright install --with-deps chromium

      - name: AWS認証情報の設定（OIDC経由）
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: デプロイ済み環境に対するE2Eテストの実行
        env:
          E2E_ENV: deployed
          FRONTEND_URL: ${{ needs.deploy.outputs.cloudfront_url }}
          BACKEND_URL: ${{ needs.deploy.outputs.api_url }}
          DYNAMODB_TABLE_NAME: attendance-kit-${{ needs.deploy.outputs.environment }}-clock
          AWS_REGION: ap-northeast-1
        run: npm run test:e2e
        timeout-minutes: 5

      - name: E2Eテストレポートのアップロード
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-dev-test-reports
          path: test/e2e/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: 失敗時のコメント
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'E2E Test - Dev Environment'
          failure-message: 'Dev環境に対するE2Eテストに失敗しました。テストログを確認してください。'

      - name: 失敗時のIssue作成
        if: failure()
        uses: ./.github/actions/create-issue-on-failure
        with:
          workflow-name: 'E2E Test - Dev Environment'
          github-token: ${{ secrets.GITHUB_TOKEN }}
