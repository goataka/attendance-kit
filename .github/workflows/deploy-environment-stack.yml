name: Deploy Environment Stack to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '!apps/website/**'
      - 'infrastructure/deploy/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-environment-stack.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

permissions:
  id-token: write   # OIDCèªè¨¼ã«å¿…è¦
  contents: read
  pull-requests: write  # PRã‚³ãƒ¡ãƒ³ãƒˆã«å¿…è¦
  issues: write  # Issueä½œæˆã«å¿…è¦

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    outputs:
      cloudfront_url: ${{ steps.deploy-outputs.outputs.cloudfront_url }}
      api_url: ${{ steps.deploy-outputs.outputs.api_url }}
      environment: ${{ steps.deploy-outputs.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm run setup

      - name: Build all workspaces
        run: npm run build --workspaces --if-present

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: CDK Bootstrap
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Running CDK bootstrap (idempotent operation)..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          npx cdk bootstrap aws://${ACCOUNT_ID}/ap-northeast-1 --context stack=environment

      - name: CDK Deploy Environment Stack
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/')-Stack"
          echo "Deploying environment stack: ${STACK_NAME}"
          npx cdk deploy ${STACK_NAME} --require-approval never \
            --context stack=environment \
            --context environment=${ENVIRONMENT}

      - name: Output deployment results
        id: deploy-outputs
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
        run: |
          echo "Deployment completed successfully for environment: ${ENVIRONMENT}"
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/')-Stack"
          
          # ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›ã‚’ä¸€åº¦ã ã‘å–å¾—
          STACK_OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs' \
            --output json)
          
          echo "Stack outputs:"
          echo "${STACK_OUTPUTS}" | jq -r '.[] | "\(.OutputKey): \(.OutputValue)"'
          
          # jqã§å¿…è¦ãªå€¤ã‚’æŠ½å‡ºï¼ˆCDKãŒConstructã§ç”Ÿæˆã™ã‚‹ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãã®ã‚­ãƒ¼åã«å¯¾å¿œï¼‰
          CLOUDFRONT_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("CloudFrontUrl")) | .OutputValue')
          API_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("ApiUrl")) | .OutputValue')
          
          # å¿…é ˆã®ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼çµ‚äº†
          if [ -z "${CLOUDFRONT_URL}" ] || [ -z "${API_URL}" ]; then
            echo "Error: Required stack outputs not found"
            echo "CLOUDFRONT_URL: ${CLOUDFRONT_URL}"
            echo "API_URL: ${API_URL}"
            exit 1
          fi
          
          echo "cloudfront_url=${CLOUDFRONT_URL}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "environment=${ENVIRONMENT}" >> $GITHUB_OUTPUT

      - name: Comment on failure
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Deploy Environment Stack'
          failure-message: 'ç’°å¢ƒã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create issue on failure
        if: failure()
        uses: ./.github/actions/create-issue-on-failure
        with:
          workflow-name: 'Deploy Environment Stack'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  e2e-test:
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.environment == 'dev'
    environment: dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm run setup

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: Run E2E Tests against Deployed Environment
        env:
          E2E_ENV: deployed
          FRONTEND_URL: ${{ needs.deploy.outputs.cloudfront_url }}
          BACKEND_URL: ${{ needs.deploy.outputs.api_url }}
          DYNAMODB_TABLE_NAME: attendance-kit-${{ needs.deploy.outputs.environment }}-clock
          AWS_REGION: ap-northeast-1
        run: npm run test:e2e
        timeout-minutes: 5

      - name: Upload E2E Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-dev-test-reports
          path: test/e2e/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: Find PR number
        if: always()
        id: find-pr
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Searching for PR associated with commit ${{ github.sha }}..."
          PR_NUM=$(gh pr list --repo ${{ github.repository }} --state all --search "${{ github.sha }}" --json number --jq '.[0].number' 2>/dev/null || echo "")
          if [ -n "${PR_NUM}" ]; then
            echo "pr_number=${PR_NUM}" >> $GITHUB_OUTPUT
            echo "Found PR: #${PR_NUM}"
          else
            echo "No PR found for commit ${{ github.sha }}"
            echo "pr_number=" >> $GITHUB_OUTPUT
          fi

      - name: Comment E2E Test Results on PR
        if: always() && steps.find-pr.outputs.pr_number != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.find-pr.outputs.pr_number }}
          header: e2e-dev-test-results
          recreate: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          message: |
            ## E2Eãƒ†ã‚¹ãƒˆçµæœ (Devç’°å¢ƒ)
            
            ğŸ“Š **ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**: [Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèªæ–¹æ³•ï¼š
            1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
            2. Artifacts ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ `e2e-dev-test-reports` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. `cucumber-report.html` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã

      - name: Comment on failure
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'E2E Test - Dev Environment'
          failure-message: 'Devç’°å¢ƒã«å¯¾ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'

      - name: Create issue on failure
        if: failure()
        uses: ./.github/actions/create-issue-on-failure
        with:
          workflow-name: 'E2E Test - Dev Environment'
          github-token: ${{ secrets.GITHUB_TOKEN }}
