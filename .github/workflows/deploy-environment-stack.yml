name: Deploy Environment Stack to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '!apps/website/**'
      - 'infrastructure/deploy/bin/**'
      - 'infrastructure/deploy/lib/attendance-kit-stack.ts'
      - 'infrastructure/deploy/lib/dynamodb-stack.ts'
      - 'infrastructure/deploy/lib/constructs/**'
      - 'infrastructure/deploy/lib/utils/**'
      - 'infrastructure/deploy/test/**'
      - 'infrastructure/deploy/package*.json'
      - 'infrastructure/deploy/tsconfig.json'
      - 'infrastructure/deploy/cdk.json'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/deploy-environment-stack.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

permissions:
  id-token: write   # OIDC認証に必要
  contents: read
  pull-requests: write  # PRコメントに必要

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm run setup

      - name: Build all workspaces
        run: npm run build --workspaces --if-present

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: CDK Bootstrap
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Running CDK bootstrap (idempotent operation)..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          npx cdk bootstrap aws://${ACCOUNT_ID}/ap-northeast-1 --context stack=environment

      - name: CDK Deploy Environment Stack
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/')-Stack"
          echo "Deploying environment stack: ${STACK_NAME}"
          npx cdk deploy ${STACK_NAME} --require-approval never \
            --context stack=environment \
            --context environment=${ENVIRONMENT}

      - name: Verify Lambda environment variables
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
        run: |
          echo "Verifying Lambda function environment variables..."
          FUNCTION_NAME="attendance-kit-${ENVIRONMENT}-api"
          
          echo "Function: ${FUNCTION_NAME}"
          aws lambda get-function-configuration \
            --function-name "${FUNCTION_NAME}" \
            --query 'Environment.Variables' \
            --output json
          
          # Verify JWT_SECRET is configured
          JWT_SECRET_VALUE=$(aws lambda get-function-configuration \
            --function-name "${FUNCTION_NAME}" \
            --query 'Environment.Variables.JWT_SECRET' \
            --output text)
          
          if [ "${JWT_SECRET_VALUE}" = "None" ] || [ -z "${JWT_SECRET_VALUE}" ]; then
            echo "❌ ERROR: JWT_SECRET is not set in Lambda function"
            exit 1
          else
            JWT_SECRET_LENGTH=${#JWT_SECRET_VALUE}
            echo "✓ JWT_SECRET is configured (length: ${JWT_SECRET_LENGTH} characters)"
            
            if [ "${JWT_SECRET_LENGTH}" -lt 32 ]; then
              echo "⚠️  WARNING: JWT_SECRET is shorter than recommended 32 characters"
            fi
          fi

      - name: Output deployment results
        env:
          ENVIRONMENT: ${{ inputs.environment || 'dev' }}
        run: |
          echo "Deployment completed successfully for environment: ${ENVIRONMENT}"
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/')-Stack"
          echo "Stack outputs:"
          aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs' \
            --output table

      - name: Comment on failure
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Deploy Environment Stack'
          failure-message: '環境スタックのデプロイに失敗しました。ログを確認してください。'
          github-token: ${{ secrets.GITHUB_TOKEN }}
