name: Deploy Infrastructure PR Workflows

on:
  pull_request:
    paths:
      - 'infrastructure/deploy/**'
      - '.github/workflows/deploy-pr.yml'

permissions:
  contents: write
  pull-requests: write

jobs:
  # Detect changes using paths-filter
  changes:
    runs-on: ubuntu-latest
    outputs:
      cdk: ${{ steps.filter.outputs.cdk }}
      snapshot: ${{ steps.filter.outputs.snapshot }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            cdk:
              - 'infrastructure/deploy/lib/**'
              - 'infrastructure/deploy/bin/**'
              - 'infrastructure/deploy/test/**'
              - 'infrastructure/deploy/package*.json'
              - 'infrastructure/deploy/tsconfig.json'
              - 'infrastructure/deploy/docker-compose.yml'
              - 'infrastructure/deploy/scripts/validate-cdk-localstack.sh'
            snapshot:
              - 'infrastructure/deploy/lib/**'
              - 'infrastructure/deploy/bin/**'
              - 'infrastructure/deploy/test/**'
              - 'infrastructure/deploy/package*.json'
              - 'infrastructure/deploy/tsconfig.json'

  # CDK Validation
  validate-cdk:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.cdk == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run CDK Validation
        uses: ./infrastructure/deploy/.github/actions/premerge-cdk


