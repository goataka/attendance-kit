name: PRç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã¨E2Eãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
    paths:
      - 'apps/backend/**'
      - 'apps/frontend/**'
      - '!apps/website/**'
      - 'infrastructure/deploy/**'
      - 'package.json'
      - 'package-lock.json'
      - 'test/e2e/**'
      - '.github/workflows/pr-deploy-and-e2e.yml'
  workflow_dispatch:

concurrency:
  group: pr-env-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  id-token: write # OIDCèªè¨¼ã«å¿…è¦
  contents: read
  pull-requests: write # PRã‚³ãƒ¡ãƒ³ãƒˆã«å¿…è¦

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    environment: eva # PRç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯evaç’°å¢ƒã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: PRç’°å¢ƒåã®ç”Ÿæˆ
        id: env-name
        uses: ./.github/actions/generate-pr-env-name
        with:
          branch-name: ${{ github.head_ref }}
          pr-number: ${{ github.event.pull_request.number }}

      - name: Node.js 24ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm run setup

      - name: å…¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰
        run: npm run build --workspaces --if-present

      - name: AWSèªè¨¼æƒ…å ±ã®è¨­å®šï¼ˆOIDCçµŒç”±ï¼‰
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: CDK Bootstrapã®å®Ÿè¡Œ
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ steps.env-name.outputs.environment-name }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Running CDK bootstrap (idempotent operation)..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          npx cdk bootstrap aws://${ACCOUNT_ID}/ap-northeast-1 --context stack=environment

      - name: CDK Deploy PRç’°å¢ƒã‚¹ã‚¿ãƒƒã‚¯
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: ${{ steps.env-name.outputs.environment-name }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/' | sed 's/-/_/g')-Stack"
          echo "Deploying PR environment stack: ${STACK_NAME}"
          npx cdk deploy ${STACK_NAME} --require-approval never \
            --context stack=environment \
            --context environment=${ENVIRONMENT}

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®å‡ºåŠ›
        id: deploy-outputs
        env:
          ENVIRONMENT: ${{ steps.env-name.outputs.environment-name }}
        run: |
          echo "Deployment completed successfully for PR environment: ${ENVIRONMENT}"
          STACK_NAME="AttendanceKit-$(echo ${ENVIRONMENT} | sed 's/./\U&/' | sed 's/-/_/g')-Stack"

          # ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›ã‚’å–å¾—
          STACK_OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs' \
            --output json)

          echo "Stack outputs:"
          echo "${STACK_OUTPUTS}" | jq -r '.[] | "\(.OutputKey): \(.OutputValue)"'

          # å¿…è¦ãªå€¤ã‚’æŠ½å‡º
          CLOUDFRONT_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("CloudFrontUrl")) | .OutputValue')
          API_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("ApiUrl")) | .OutputValue')

          if [ -z "${CLOUDFRONT_URL}" ] || [ -z "${API_URL}" ]; then
            echo "Error: Required stack outputs not found"
            echo "CLOUDFRONT_URL: ${CLOUDFRONT_URL}"
            echo "API_URL: ${API_URL}"
            exit 1
          fi

          echo "cloudfront_url=${CLOUDFRONT_URL}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ç’°å¢ƒã«å¯¾ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        env:
          E2E_ENV: deployed
          FRONTEND_URL: ${{ steps.deploy-outputs.outputs.cloudfront_url }}
          BACKEND_URL: ${{ steps.deploy-outputs.outputs.api_url }}
          NODE_ENV: ${{ steps.env-name.outputs.environment-name }}
          AWS_REGION: ap-northeast-1
          DYNAMODB_TABLE_NAME: attendance-kit-${{ steps.env-name.outputs.environment-name }}-clock
        run: npm run test:e2e
        timeout-minutes: 10

      - name: E2Eãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pr-${{ github.event.pull_request.number }}-test-reports
          path: test/e2e/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: PRã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆçµæœã‚³ãƒ¡ãƒ³ãƒˆ
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-deploy-e2e-results
          recreate: true
          message: |
            ## PRç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã¨E2Eãƒ†ã‚¹ãƒˆçµæœ

            **ç’°å¢ƒå**: `${{ steps.env-name.outputs.environment-name }}`

            **ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}

            **ã‚¢ã‚¯ã‚»ã‚¹URL**:
            - ğŸŒ Frontend: ${{ steps.deploy-outputs.outputs.cloudfront_url }}
            - ğŸ”Œ Backend API: ${{ steps.deploy-outputs.outputs.api_url }}

            **E2Eãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**: [Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèªæ–¹æ³•ï¼š
            1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
            2. Artifacts ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ `e2e-pr-${{ github.event.pull_request.number }}-test-reports` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. `cucumber-report.html` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã

            ---
            ğŸ’¡ ã“ã®PRç’°å¢ƒã¯PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸæ™‚ã«è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

      - name: å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'PRç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã¨E2Eãƒ†ã‚¹ãƒˆ'
          failure-message: 'PRç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ãŸã¯E2Eãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}
