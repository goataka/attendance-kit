name: Deploy Account Stack to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'infrastructure/account/**'
      - '.github/workflows/deploy-account-stack.yml'
  workflow_dispatch:

permissions:
  id-token: write # OIDC認証に必要
  contents: read
  pull-requests: write # PRコメントに必要
  issues: write # Issue作成に必要

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production # アカウントレベルリソースは本番環境として扱う

    steps:
      - name: コードのチェックアウト
        uses: actions/checkout@v4

      - name: Node.js 24のセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: infrastructure/account/package-lock.json

      - name: 依存関係のインストール
        working-directory: infrastructure/account
        run: npm run setup

      - name: TypeScriptのビルド
        working-directory: infrastructure/account
        run: npm run build

      - name: AWS認証情報の設定（OIDC経由）
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: CDK Bootstrapの実行
        working-directory: infrastructure/account
        env:
          COST_ALERT_EMAIL: ${{ secrets.COST_ALERT_EMAIL }}
        run: |
          echo "Running CDK bootstrap (idempotent operation)..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          npx cdk bootstrap aws://${ACCOUNT_ID}/ap-northeast-1

      - name: CDK Deployアカウントスタック
        working-directory: infrastructure/account
        env:
          COST_ALERT_EMAIL: ${{ secrets.COST_ALERT_EMAIL }}
        run: |
          echo "Deploying account stack: AttendanceKit-Account-Stack"
          npx cdk deploy AttendanceKit-Account-Stack --require-approval never

      - name: デプロイ結果の出力
        run: |
          echo "Deployment completed successfully for account stack"
          echo "Stack outputs:"
          aws cloudformation describe-stacks \
            --stack-name AttendanceKit-Account-Stack \
            --query 'Stacks[0].Outputs' \
            --output table

      - name: SNSサブスクリプションの確認
        run: |
          echo "⚠️  Important: Check your email for SNS subscription confirmation"
          echo "Email address: ${{ secrets.COST_ALERT_EMAIL }}"
          echo "You must click the confirmation link to receive cost alerts"

      - name: 失敗時のコメント
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Deploy Account Stack'
          failure-message: 'アカウントスタックのデプロイに失敗しました。ログを確認してください。'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: 失敗時のIssue作成
        if: failure()
        uses: ./.github/actions/create-issue-on-failure
        with:
          workflow-name: 'Deploy Account Stack'
          github-token: ${{ secrets.GITHUB_TOKEN }}
