name: Pre-merge CDK Validation

on:
  pull_request:
    paths:
      - 'infrastructure/deploy/lib/**/*.ts'
      - 'infrastructure/deploy/bin/**/*.ts'
      - 'infrastructure/deploy/test/**/*.test.ts'
      - 'infrastructure/deploy/package*.json'
      - 'infrastructure/deploy/tsconfig.json'
      - 'infrastructure/deploy/docker-compose.yml'
      - '.github/workflows/premerge-cdk.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-cdk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: infrastructure/deploy/package-lock.json

      - name: Install dependencies
        working-directory: infrastructure/deploy
        run: npm ci

      - name: Build TypeScript
        working-directory: infrastructure/deploy
        run: npm run build

      - name: Run tests
        working-directory: infrastructure/deploy
        run: npm test

      - name: Start LocalStack
        working-directory: infrastructure/deploy
        run: npm run localstack:start

      - name: Wait for LocalStack to be ready
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "\"dynamodb\": \"available\""; do sleep 2; done'
          echo "LocalStack is ready!"

      - name: Debug - Display Environment Variables
        working-directory: infrastructure/deploy
        run: |
          echo "=== Environment Variables ==="
          echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-not set}"
          echo "AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-not set}"
          echo "AWS_DEFAULT_REGION: ${AWS_DEFAULT_REGION:-not set}"
          echo "CDK_DEFAULT_ACCOUNT: ${CDK_DEFAULT_ACCOUNT:-not set}"
          echo "CDK_DEFAULT_REGION: ${CDK_DEFAULT_REGION:-not set}"
          echo "NODE_VERSION: $(node --version)"
          echo "NPM_VERSION: $(npm --version)"
          echo "=== LocalStack Health Check ==="
          curl -s http://localhost:4566/_localstack/health | jq '.' || echo "Failed to get health status"
        env:
          AWS_ACCESS_KEY_ID: "test"
          AWS_SECRET_ACCESS_KEY: "test"
          AWS_DEFAULT_REGION: "ap-northeast-1"

      - name: CDK Bootstrap
        working-directory: infrastructure/deploy
        run: npm run localstack:bootstrap
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          LOCALSTACK_HOSTNAME: localhost
          CDK_DEFAULT_ACCOUNT: "000000000000"
          CDK_DEFAULT_REGION: ap-northeast-1

      - name: CDK Synth
        working-directory: infrastructure/deploy
        run: npm run localstack:synth
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          LOCALSTACK_HOSTNAME: localhost
          CDK_DEFAULT_ACCOUNT: "000000000000"
          CDK_DEFAULT_REGION: ap-northeast-1

      - name: CDK Deploy to LocalStack
        working-directory: infrastructure/deploy
        run: npm run localstack:deploy
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: ap-northeast-1
          AWS_ENDPOINT_URL: http://localhost:4566
          LOCALSTACK_HOSTNAME: localhost
          CDK_DEFAULT_ACCOUNT: "000000000000"
          CDK_DEFAULT_REGION: ap-northeast-1

      - name: Run DynamoDB Integration Tests
        working-directory: infrastructure/deploy
        run: npm run test:integration
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: ap-northeast-1

      - name: Stop LocalStack
        if: always()
        working-directory: infrastructure/deploy
        run: npm run localstack:stop

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = [
              '## ✅ CDK Pre-merge Validation Passed',
              '',
              'すべてのCDK検証が成功しました:',
              '',
              '- ✅ TypeScriptビルド成功',
              '- ✅ ユニットテスト通過',
              '- ✅ CDK Synth成功',
              '- ✅ LocalStackへのデプロイ成功',
              '- ✅ DynamoDB統合テスト通過 (jest)',
              '',
              'このPRはマージ可能です。'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Comment on PR failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = [
              '## ❌ CDK Pre-merge Validation Failed',
              '',
              'CDK検証中にエラーが発生しました。',
              '',
              '詳細はワークフローログを確認してください:',
              `[ワークフロー実行ログ](${context.payload.repository.html_url}/actions/runs/${context.runId})`,
              '',
              '問題を修正してから再度プッシュしてください。'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
