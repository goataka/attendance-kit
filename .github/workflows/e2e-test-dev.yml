name: E2E Test for Dev Environment

on:
  workflow_run:
    workflows: ["Deploy Environment Stack to AWS"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write   # OIDCèªè¨¼ã«å¿…è¦
  contents: read
  pull-requests: write

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: >-
      ${{ github.event.workflow_run.conclusion == 'success' ||
          github.event_name == 'workflow_dispatch' }}
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm run setup

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: Get CloudFormation Stack Outputs
        id: stack-outputs
        run: |
          STACK_NAME="AttendanceKit-Dev-Stack"

          # CloudFrontã®URLã‚’å–å¾—
          CLOUDFRONT_URL=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query \
              'Stacks[0].Outputs[?OutputKey==`CloudFrontUrl`].OutputValue' \
            --output text)

          # APIã®URLã‚’å–å¾—
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiUrl`].OutputValue' \
            --output text)

          # DynamoDBãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å–å¾—
          TABLE_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs[?OutputKey==`TableName`].OutputValue' \
            --output text)

          echo "cloudfront_url=${CLOUDFRONT_URL}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT
          echo "table_name=${TABLE_NAME}" >> $GITHUB_OUTPUT

          echo "CloudFront URL: ${CLOUDFRONT_URL}"
          echo "API URL: ${API_URL}"
          echo "Table Name: ${TABLE_NAME}"

      - name: Run E2E Tests against Dev Environment
        env:
          E2E_ENV: deployed
          FRONTEND_URL: ${{ steps.stack-outputs.outputs.cloudfront_url }}
          BACKEND_URL: ${{ steps.stack-outputs.outputs.api_url }}
          DYNAMODB_TABLE_NAME: ${{ steps.stack-outputs.outputs.table_name }}
          AWS_REGION: ap-northeast-1
        run: npm run test:e2e
        timeout-minutes: 5

      - name: Upload E2E Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-dev-test-reports
          path: test/e2e/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: Comment E2E Test Results
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runId = context.runId;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const artifactUrl =
              `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            const status =
              '${{ job.status }}' === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—';

            const comment = `## Devç’°å¢ƒ E2Eãƒ†ã‚¹ãƒˆçµæœ

            **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${status}

            ğŸ“Š **ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**: [Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](${artifactUrl})

            **ãƒ†ã‚¹ãƒˆå¯¾è±¡**:
            - Frontend: ${{ steps.stack-outputs.outputs.cloudfront_url }}
            - Backend: ${{ steps.stack-outputs.outputs.api_url }}

            ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèªæ–¹æ³•ï¼š
            1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
            2. Artifacts ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ \`e2e-dev-test-reports\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. \`cucumber-report.html\` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
            `;

            // æœ€è¿‘ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆworkflow_runã®å ´åˆï¼‰
            if (context.eventName === 'workflow_run') {
              const commits = await github.rest.repos.listCommits({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.payload.workflow_run.head_sha,
                per_page: 1
              });

              if (commits.data.length > 0) {
                await github.rest.repos.createCommitComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  commit_sha: commits.data[0].sha,
                  body: comment
                });
              }
            }

      - name: Comment on failure
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'E2E Test for Dev Environment'
          failure-message: 'Devç’°å¢ƒã«å¯¾ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}
