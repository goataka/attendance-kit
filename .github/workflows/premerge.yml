name: Premerge Checks

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  CHECKOUT_REF: ${{ github.head_ref || github.ref }}

permissions:
  id-token: write # OIDCèªè¨¼ã«å¿…è¦
  contents: write
  pull-requests: write

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ github.event_name == 'workflow_dispatch' || steps.filter.outputs.non-md == 'true' }}
    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4

      - name: å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if: github.event_name == 'pull_request'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            non-md:
              - '!**/*.[mM][dD]'

  unit-test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-run-tests == 'true'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm run setup

      - name: TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Lintã®å®Ÿè¡Œ
        run: npm run lint

      - name: ãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œ
        run: npm run build

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: npm run test:unit

      - name: æˆæœç‰©ã®ç”Ÿæˆ
        run: npm run generate

      - name: å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã‚³ãƒŸãƒƒãƒˆã¨ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: ./.github/actions/commit-and-comment
        with:
          files: |
            **/__snapshots__/**
            apps/backend/api/openapi.json
          commit-message: 'è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°: ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¨OpenAPI'
          pr-comment: 'âœ… è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã€OpenAPIä»•æ§˜ï¼‰'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Premerge - Unit Test'
          failure-message: 'ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Lintã€ãƒ“ãƒ«ãƒ‰ã€ã¾ãŸã¯ãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  backend-integration-test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-run-tests == 'true'

    env:
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_DEFAULT_REGION: ap-northeast-1
      JWT_SECRET: test-secret-key

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm run setup

      - name: TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: å…¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰
        run: npm run build

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        run: npm run test:integration --workspace=@attendance-kit/backend

      - name: å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Premerge - Backend Integration Test'
          failure-message: 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚LocalStackã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¾ãŸã¯ãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  cdk-synth-test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-run-tests == 'true'

    env:
      JWT_SECRET: test-secret-key

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm run setup

      - name: TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: å…¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰
        run: npm run build

      - name: CDK Synthãƒ†ã‚¹ãƒˆ
        working-directory: infrastructure/deploy
        run: |
          npx cdk synth --context stack=environment --context environment=test

      - name: å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Premerge - CDK Synth Test'
          failure-message: 'CDK Synthãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚³ãƒ¼ãƒ‰ã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  frontend-integration-test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-run-tests == 'true'

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm run setup

      - name: TurboRepoã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        working-directory: apps/frontend
        run: npm run test:integration

      - name: å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Premerge - Frontend Integration Test'
          failure-message: 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚Playwrightãƒ†ã‚¹ãƒˆã®ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}

  deploy-and-e2e-test:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.should-run-tests == 'true'
    environment: eva # PRç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯evaç’°å¢ƒã®èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨

    steps:
      - name: ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: Node.js 24ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm run setup

      - name: å…¨ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰
        run: npm run build --workspaces --if-present

      - name: AWSèªè¨¼æƒ…å ±ã®è¨­å®šï¼ˆOIDCçµŒç”±ï¼‰
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-northeast-1

      - name: CDK Bootstrapã®å®Ÿè¡Œ
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: pr-${{ github.event.pull_request.number }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Running CDK bootstrap (idempotent operation)..."
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          npx cdk bootstrap aws://${ACCOUNT_ID}/ap-northeast-1 --context stack=environment

      - name: CDK Deploy PRç’°å¢ƒã‚¹ã‚¿ãƒƒã‚¯
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: pr-${{ github.event.pull_request.number }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo "Deploying PR environment stack for environment: ${ENVIRONMENT}"
          npx cdk deploy --all --require-approval never \
            --context stack=environment \
            --context environment=${ENVIRONMENT}

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®å‡ºåŠ›
        id: deploy-outputs
        working-directory: infrastructure/deploy
        env:
          ENVIRONMENT: pr-${{ github.event.pull_request.number }}
        run: |
          echo "Deployment completed successfully for PR environment: ${ENVIRONMENT}"
          
          # CDKå‡ºåŠ›ã‹ã‚‰ã‚¹ã‚¿ãƒƒã‚¯åã‚’å–å¾—
          STACK_NAME=$(npx cdk list --context stack=environment --context environment=${ENVIRONMENT} | head -1)
          echo "Stack name: ${STACK_NAME}"

          # ã‚¹ã‚¿ãƒƒã‚¯å‡ºåŠ›ã‚’å–å¾—
          STACK_OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name ${STACK_NAME} \
            --query 'Stacks[0].Outputs' \
            --output json)

          echo "Stack outputs:"
          echo "${STACK_OUTPUTS}" | jq -r '.[] | "\(.OutputKey): \(.OutputValue)"'

          # å¿…è¦ãªå€¤ã‚’æŠ½å‡º
          CLOUDFRONT_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("CloudFrontUrl")) | .OutputValue')
          API_URL=$(echo "${STACK_OUTPUTS}" | jq -r '.[] | select(.OutputKey | contains("ApiUrl")) | .OutputValue')

          if [ -z "${CLOUDFRONT_URL}" ] || [ -z "${API_URL}" ]; then
            echo "Error: Required stack outputs not found"
            echo "CLOUDFRONT_URL: ${CLOUDFRONT_URL}"
            echo "API_URL: ${API_URL}"
            exit 1
          fi

          echo "cloudfront_url=${CLOUDFRONT_URL}" >> $GITHUB_OUTPUT
          echo "api_url=${API_URL}" >> $GITHUB_OUTPUT

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ç’°å¢ƒã«å¯¾ã™ã‚‹E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        env:
          E2E_ENV: deployed
          FRONTEND_URL: ${{ steps.deploy-outputs.outputs.cloudfront_url }}
          BACKEND_URL: ${{ steps.deploy-outputs.outputs.api_url }}
          NODE_ENV: pr-${{ github.event.pull_request.number }}
          AWS_REGION: ap-northeast-1
          # DynamoDB table naming convention: attendance-kit-{environment}-clock
          # This must match the table name pattern in infrastructure/deploy/lib/attendance-kit-stack.ts
          DYNAMODB_TABLE_NAME: attendance-kit-pr-${{ github.event.pull_request.number }}-clock
        run: npm run test:e2e
        timeout-minutes: 10

      - name: E2Eãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-pr-${{ github.event.pull_request.number }}-test-reports
          path: test/e2e/reports/
          retention-days: 30
          if-no-files-found: warn

      - name: PRã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆçµæœã‚³ãƒ¡ãƒ³ãƒˆ
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-deploy-e2e-results
          recreate: true
          message: |
            ## PRç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã¨E2Eãƒ†ã‚¹ãƒˆçµæœ

            **ç’°å¢ƒå**: `pr-${{ github.event.pull_request.number }}`

            **ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}

            **ã‚¢ã‚¯ã‚»ã‚¹URL**:
            - ğŸŒ Frontend: ${{ steps.deploy-outputs.outputs.cloudfront_url }}
            - ğŸ”Œ Backend API: ${{ steps.deploy-outputs.outputs.api_url }}

            **E2Eãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ**: [Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèªæ–¹æ³•ï¼š
            1. ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
            2. Artifacts ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ `e2e-pr-${{ github.event.pull_request.number }}-test-reports` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. `cucumber-report.html` ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã

            ---
            ğŸ’¡ ã“ã®PRç’°å¢ƒã¯PRãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸæ™‚ã«è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚

      - name: å¤±æ•—æ™‚ã®ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure()
        uses: ./.github/actions/comment-on-failure
        with:
          workflow-name: 'Premerge - Deploy and E2E Test'
          failure-message: 'PRç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ãŸã¯E2Eãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
          github-token: ${{ secrets.GITHUB_TOKEN }}

