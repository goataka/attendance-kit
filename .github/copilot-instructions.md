# GitHub Copilot カスタムインストラクション

このドキュメントに記載された指示に加えて、以下のリンク先ドキュメントの内容も指示として考慮してください:
- [Agent開発ガイドライン](./agents/AGENTS.md) - エージェントの役割とプロジェクトサマリー
- [コーディング規約](./instructions/coding.instructions.md) - 一般的なコーディング原則と理解しやすいコードの書き方
- [シェルスクリプト規約](./instructions/sh.instructions.md) - シェルスクリプト固有のコーディングルールとテスト規約
- [TypeScript規約](./instructions/typescript.instructions.md) - TypeScript固有のコーディングルールとCDK Constructルール
- [Markdown規約](./instructions/markdown.instructions.md) - ドキュメント作成ルール

## 言語ポリシー

このリポジトリでは、以下の言語ポリシーを遵守してください:

### 日本語を使用する箇所

1. **PRのタイトルとサマリー**: すべてのPull Requestのタイトルと説明は日本語で記述してください
2. **コミットメッセージ**: すべてのコミットメッセージは日本語で記述してください
3. **コードレビューコメント**: レビューコメントは日本語で記述してください
4. **Issue**: Issueのタイトルと説明は日本語で記述してください
5. **仕様書とドキュメント**: spec.md、plan.md、tasks.mdなど、すべての仕様書とドキュメントは日本語で記述してください
6. **Agentとのやり取り**: GitHub Copilot Agentとのすべてのやり取りは日本語で行ってください
7. **エージェントセッション内の作業**: エージェントがタスクを実行する際の思考過程、調査内容、実行コマンド、結果の解釈など、セッション内のすべての作業記録は日本語で記述してください
8. **コードコメント**: コード内のコメントは日本語で記述してください
   - チーム内のコミュニケーションを円滑にし、コードの可読性を向上させるため
9. **GitHub Actionsワークフローのステップ名**: `.github/workflows/`内のYAMLファイルの`name`属性は日本語で記述してください
   - 技術用語（AWS、Node.js、CDK、OIDC、Playwright等）は英語のまま維持し、動詞と説明文を日本語化してください
   - 例: `Setup Node.js 24` → `Node.js 24のセットアップ`、`Run unit tests` → `ユニットテストの実行`

### 英語を使用する箇所

1. **コード**: 変数名、関数名、クラス名は英語で記述してください
2. **技術用語**: 技術的な固有名詞はそのまま英語を使用してください（例: OIDC, CDK, CloudFormation）

## PR差分リンク提示のルール

エージェントが作業報告でPR差分へのリンクを提示する際は、必ずGitHubのPRファイル差分ページへのリンクを付ける:

**形式**:
```
PR差分: [#PR番号](https://github.com/goataka/attendance-kit/pull/PR番号/changes/始点コミット..終点コミット)
```

**例**:
```
PR差分: [#124](https://github.com/goataka/attendance-kit/pull/124/changes/aa72f4012345678901234567890123456789abcd..ceb2bd6789abcdef0123456789abcdef01234567)
```

**理由**:
- ユーザーがワンクリックで今回の作業によるコミット差分を確認可能
- そのままApproveボタンを押してレビュー完了できる
- コードレビューの効率化
- 変更履歴の追跡性向上

**PR番号の取得方法**:
```bash
# GitHub MCPツールを使用してPR番号を取得
# 現在のブランチ名を確認
git branch --show-current

# そのブランチのPRを検索
# github-mcp-server-search_pull_requests を使用
# query: "head:<ブランチ名> is:open"
```

**注意**:
- 始点コミットは作業開始前のコミット、終点コミットは作業完了時のコミットを指定
- **PR番号は必ず実際の番号を使用してください**
  - 「現在のPR番号」「PR番号」などのプレースホルダーは使用禁止
  - GitHub MCPツールで現在のブランチのPR番号を取得してください
- **コミットハッシュは必ず完全形（40文字）を使用してください**
  - 短縮形（7文字）はGitHubのchangesページで機能しません
  - `git log --format=%H`で完全なコミットハッシュを取得できます
- このルールは必須です。PR差分リンクを提示する際は必ず遵守してください

## Agentの動作ガイドライン

### スキル優先の原則

エージェントは、タスクを実行する前に**必ず利用可能なスキルを確認**し、該当するスキルがある場合は**そのスキルを優先的に使用**してください:

1. **スキル確認の義務**: タスク開始時に`.github/skills/`配下のスキルを確認
2. **スキル利用の優先**: 該当スキルがある場合は、直接対応せずにスキルを使用
3. **判断の記録**: スキルを使用する/しない判断とその理由を必ず記録

#### 利用可能なスキル

以下のスキルが利用可能です。該当する場合は**必ず使用**してください:

- **aws-investigation**: AWS調査
  - **使用すべき状況**: AWSリソースの調査を依頼された場合、デプロイされたインフラの状態確認が必要な場合
  - **使用しない状況**: AWS環境へのデプロイや変更を行う場合（読み取り専用スキル）
  - **判断基準**: CloudFormationスタック、DynamoDB、Lambda、API Gatewayなどのリソース情報を確認する必要がある場合は使用

- **backend-developer**: Backend開発
  - **使用すべき状況**: Backend（apps/backend）のコード変更時、NestJS APIの実装や修正時
  - **使用しない状況**: Backend以外のプロジェクト（Frontend、Infrastructure）の変更時
  - **判断基準**: Backendのコントローラー、サービス、エンティティなどを変更する場合は使用

- **cloudfront-error-handler**: CloudFrontエラー対応
  - **使用すべき状況**: CloudFront経由のアクセスでエラーが発生した場合
  - **使用しない状況**: CloudFront以外のエラー（ワークフローエラーなど）の場合
  - **判断基準**: API GatewayやLambdaとの連携不具合が疑われる場合は使用

- **e2e-developer**: E2E開発
  - **使用すべき状況**: E2Eテスト（test/e2e/）のコード変更時、FeatureファイルやStep definitionsの実装や修正時
  - **使用しない状況**: 個別のアプリケーション（Backend、Frontend）のテスト変更時
  - **判断基準**: Cucumber + Playwrightを使用したE2Eテストを変更する場合は使用

- **file-refactor**: ファイル/フォルダの名称変更・削除と参照更新
  - **使用すべき状況**: ファイルやフォルダのリネーム・削除を依頼された場合

- **frontend-developer**: Frontend開発
  - **使用すべき状況**: Frontend（apps/frontend）のコード変更時、Reactコンポーネントやページの実装や修正時
  - **使用しない状況**: Frontend以外のプロジェクト（Backend、Infrastructure）の変更時
  - **判断基準**: Reactコンポーネント、画面、スタイルなどを変更する場合は使用

- **infrastructure-developer**: Infrastructure開発
  - **使用すべき状況**: Infrastructure（infrastructure/deploy）のコード変更時、CDKスタックや設定の変更時
  - **使用しない状況**: Infrastructure以外のプロジェクト（Backend、Frontend）の変更時
  - **判断基準**: CDKスタック、Construct、AWSリソース定義を変更する場合は使用

- **premerge-check**: プレマージワークフローのローカル実行
  - **使用すべき状況**: PRを作成する前にローカルでCI/CDチェックを実行したい場合

- **rule-making**: ルール化の依頼対応
  - **使用すべき状況**: ユーザーから「ルール化してください」というリクエストがあった場合

- **workflow-error-handler**: ワークフローのエラー対応
  - **使用すべき状況**: GitHub Actionsワークフローが失敗した場合、CI/CDパイプラインでエラーが発生した場合
  - **使用しない状況**: ワークフローファイルの軽微な設定変更（環境変数追加など）のみの場合
  - **判断基準**: エラーログの確認、再現、原因特定、対処、検証という体系的なプロセスが必要な場合は使用

### 変更実行前の必須プロセス

エージェントは、コードやドキュメントの変更を提案・適用する前に、以下のプロセスを必ず実行してください:

1. **スキル確認**: 利用可能なスキルを確認し、該当するものがあれば使用する
2. **現状調査**: 対象ファイルの構造と内容を確認し、どの検証コマンドが必要かを判断する
3. **実行場所の確認**: プロジェクトのルートディレクトリ（`/home/runner/work/attendance-kit/attendance-kit`）で検証コマンドを実行する
4. **スクリプトの利用**: `package.json`に定義されたnpmスクリプトを優先的に使用する
5. **思考の明示**: アクションを起こす前に、なぜそのコマンドが必要か、どのような結果を期待するかを明示する

### 作業プロセスの記録義務

エージェントは作業中、以下を**日本語で**セッション内に記録してください:

1. **検討過程の記録**:
   - 問題の分析プロセス
   - 複数の解決策の比較検討
   - 選択した解決策の理由
   - 予想される影響範囲

2. **スキル利用の判断記録**:
   - **タスク開始時**: 利用可能なスキルの確認結果を必ず記録
   - **スキルを使用した場合**: どのスキルを、なぜ使用したか
   - **スキルを使用しなかった場合**: その理由を具体的に記述
     - 例: 「該当スキルがない」、「軽微な設定変更のみでスキルの体系的プロセスは不要」、「スキルの対象外のタスク」

3. **実行ログ**:
   - 実行したコマンドとその目的
   - コマンド実行結果の要約
   - 結果の解釈と次のアクションの判断

### 結果報告の必須項目

タスク完了時の報告には、以下を必ず含めてください:

1. **実施内容サマリー**（日本語）
2. **スキル利用状況**:
   - 使用したスキル名とその役割
   - スキルを使用しなかった場合はその旨を明記
3. **検証結果**:
   - 実行した検証コマンドと結果
   - 成功・失敗の判断根拠
4. **変更の影響範囲**
5. **コミットID**（該当する場合）

### エージェントセッション終了時のPRコメント投稿

**義務**: エージェントがタスクを完了し、セッションを終了する際は、**必ず結果報告をPRにコメントとして投稿してください**。

#### 投稿タイミング

以下の場合にPRコメントを投稿してください:

- タスクの完了時（成功・失敗にかかわらず）
- セッションを終了する前
- 最終的な`report_progress`を実行した後

#### コメントフォーマット

PRコメントには以下の内容を含めてください。

**注**: 以下はテンプレートです。山括弧（`< >`）で囲まれた部分を実際の内容に置き換えてください。

```markdown
## エージェントセッション完了報告

### 実施内容
<実施内容のサマリーを記載>

### スキル利用状況
<使用したスキル名とその役割、または使用しなかった旨を記載>

### 検証結果
<実行した検証コマンドと結果を記載>

**検証コマンド例**:
- ✅ `npm run build`: 成功
- ✅ `npm test`: 成功
- ✅ `npm run lint`: 成功

### 変更の影響範囲
<変更した箇所とその影響範囲を記載>

### PR差分
<PR差分へのリンクを記載>

**重要**: 本ドキュメントの「[PR差分リンク提示のルール](#pr差分リンク提示のルール)」セクションに従ってリンクを生成してください。
```

#### 投稿方法

GitHub MCPツールを使用してPRにコメントを投稿してください。適切なMCPツール（例: `github-mcp-server`）を使用してPRコメントを投稿します。

#### セキュリティ注意事項

PRコメント投稿時は、本ドキュメントの「[秘匿情報の取り扱い](#秘匿情報の取り扱い)」セクションに従ってください。

## 変更時・適用前の検証義務（Agent実行ルール）

エージェントはコードの変更を提案または適用する際、ユーザーに指示される前に**自律的にターミナル（bashツール）を使用して以下の検証を実行し、その結果を報告しなければなりません。**

### コード変更の場合の必須アクション

変更を適用する前に、必ず以下のコマンドを**プロジェクトルートディレクトリで実行**してください:

1. **検証実行**:
   - ビルド確認: `npm run build`
   - テスト実行: `npm test`
   - Lint実行: `npm run lint`（package.jsonに定義がある場合）
   
2. **エラー発生時の対応**:
   - 検証コマンドが失敗した場合、**タスクを完了とせず**、エラー原因を特定してコードを修正してください
   - 修正後、再度検証を実行し、すべてのチェックがパスするまで繰り返してください
   - 修正案を提示し、ユーザーに確認を求めてから再試行することも可能です
   
3. **報告要件**: 
   - 完了報告時に「実行した検証コマンドとその結果」を必ず含めてください
   - ターミナル出力の重要部分を引用し、成功・失敗の判断根拠を明示してください

### ドキュメント・Mermaid図変更の場合

ドキュメントやMermaid図の変更時も、以下の検証を実行してください:

1. **構文チェック**: 
   - Markdownの構文が正しいことを確認してください
   - Mermaidであれば、構文エラーがないかを検証してください
   
2. **視覚的整合性**: 
   - リンク切れがないか確認してください
   - 言語ポリシー（日本語/英語の使い分け）に矛盾がないか最終確認してください

### 反復確認の原則

変更適用後は、以下の確認を実施してください:

- 変更対象の漏れがないか、全ファイルを確認
- 類似パターンの箇所を検索し、一貫性を確保
- 変更後に影響範囲を再チェック

### 検証の自動化原則

- **実機確認の義務**: エージェントは検証を省略してはいけません。必ず実際にターミナルでコマンドを実行し、その出力に基づいて判断してください
- **虚偽報告の禁止**: 「検証をやっておきました」という虚偽の報告をしてはいけません。実際のターミナル出力を示してください
- **早期検証**: 変更を適用したら、できるだけ早く検証を実行し、問題の早期発見に努めてください

## ドキュメント配置の原則

### ドキュメント構造ポリシー

1. **戦略的・概念的なドキュメント**: `docs/`ディレクトリに配置
   - アーキテクチャ設計
   - ビジネス要件
   - デプロイメント戦略

2. **フォルダ単位のドキュメント**: 該当フォルダのREADME.mdにWARNING以上の情報のみ記載
   - `.github/workflows/README.md`: 全ワークフローの一覧と必須設定
   - `.github/actions/README.md`: 全アクションの一覧と必須設定
   - `infrastructure/DEPLOYMENT.md`: デプロイ手順の概要
   - `infrastructure/setup/README.md`: セットアップ手順

3. **詳細仕様は実装ファイルで確認**
   - 個別ワークフローの詳細: `.yml`ファイルを参照
   - コンポーネントの詳細仕様: `.tsx`、`.test.tsx`ファイルを参照
   - 詳細仕様やテスト方針の個別ファイル（`TESTING.md`、`SPEC.md`等）は作成しない

4. **冗長性の回避**
   - 「関連ドキュメント」セクションは記載しない
   - システム名など変更箇所が増える記述は必須でない場所には記載しない
   - 保守負担を最小化するため、重複情報を避ける

5. **ナンバリングの回避**
   - タスクやステップの番号付けは極力しない（変更箇所が増えるため）
   - 順序を示す必要がある場合は、リスト構造で表現し、タスク内容には番号を含めない
   - 例: ❌ "タスク 1: XXX" → ✅ "タスク: XXX"（リストの順序で表現）

### マークダウンファイルの言語ルール

1. **日本語の説明に続く英語翻訳は削除する**
   - 例: "概要 / Overview" → "概要"

2. **保持すべき英語**:
   - 技術用語（Docker, Python, Git, etc.）
   - コマンド名とコード例
   - ファイル名とパス
   - URL と外部参照

3. **確認方法**:
   ```bash
   # 日本語/英語の形式をチェック
   grep -n " / " [file.md]
   ```

## Mermaid図の活用

### ルール

- Markdown内の図はMermaidを使用して作成してください

### 理由

- テキストベースでバージョン管理可能
- レビューが容易
- 保守性が高い
- GitHubで直接レンダリング可能

### 図の種類

- システムアーキテクチャ: `graph` または `flowchart`
- シーケンス図: `sequenceDiagram`
- ER図: `erDiagram`
- 状態遷移図: `stateDiagram-v2`
- クラス図: `classDiagram`
- ガントチャート: `gantt`

## セキュリティ要件

- IAM権限は特定のリソースパターンにスコープし、ワイルドカード(`*`)の使用を避けてください
- OIDC信頼ポリシーはリポジトリ固有のGitHub Actionsに制限してください
- AWSマネージドポリシー（PowerUserAccessなど）の使用は最小限にし、必要な権限のみを付与してください

### 秘匿情報の取り扱い

エージェントは作業中、秘匿情報を適切に保護しなければなりません：

**禁止事項**:
- GitHub Secretsで設定された値（`secrets.*`）を直接出力しない
- 環境変数として設定された秘匿情報（APIキー、トークン、パスワード等）をログに出力しない
- 秘匿情報をコメント、PR説明、Issue、コミットメッセージなど人間が読める場所に記載しない
- 秘匿情報を含むデバッグ出力やエラーメッセージを表示しない

**対応方法**:
- 秘匿情報を扱う必要がある場合、変数名や設定項目名のみを記載する
- 例: 「`JWT_SECRET`が設定されていることを確認しました」（値は出力しない）
- 秘匿情報を含む可能性のあるログやデバッグ出力は、マスキングまたは省略する
- コード内で秘匿情報を扱う場合、環境変数経由で参照し、ハードコーディングしない

**理由**:
- セキュリティインシデントの防止
- 秘匿情報の漏洩によるシステムへの不正アクセスの防止
- コンプライアンス要件の遵守

## コスト最適化

- CloudWatch アラームなど、コストがかかる監視機能は初期段階では実装しないでください
- DynamoDB は On-Demand 課金モデルを使用してください
- 無料枠の範囲で利用できる基本的なメトリクスのみを使用してください

