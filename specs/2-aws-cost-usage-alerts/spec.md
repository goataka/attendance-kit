# 機能仕様: AWS利用金額アラート

**機能ブランチ**: `copilot/create-usage-alert-feature`  
**作成日**: 2025-12-31  
**ステータス**: 下書き  
**入力**: ユーザー説明: "利用金額のアラートを作成する。予算は1000円とする。利用額が超えた場合と予測額が超えそうな場合に通知。通知先はスマホアプリ"

<!--
  🌏 言語ポリシー:
  - この仕様書は日本語で記述してください
  - ユーザーストーリー、要件、説明は日本語で
  - 技術用語は英語を併記しても構いません
-->

## ユーザーシナリオとテスト *(mandatory)*

### ユーザーストーリー 1 - AWS利用額の超過検知 (優先度: P1)

システム管理者として、AWS利用額が設定した予算（1000円）を超えた場合に即座に通知を受け取りたい。これにより、予期せぬコスト超過に迅速に対応できる。

**この優先度の理由**: 実際の利用額が予算を超えた場合は緊急性が高く、即座に対応が必要なため最優先。予算超過による財務的影響を最小限に抑えることができる。

**独立テスト**: AWS Budgetで予算を設定し、実際の利用額が予算を超えた際にSNSトピック経由でスマホアプリに通知が届くことをテスト可能。

**受け入れシナリオ**:

1. **前提** AWS予算が1000円で設定されている, **実行** AWS利用額が1000円を超える, **結果** スマホアプリに利用額超過の通知が届く
2. **前提** AWS予算アラートが設定されている, **実行** 利用額が予算内である, **結果** 通知は送信されない
3. **前提** 利用額が予算を超過している, **実行** SNSトピックにメッセージがパブリッシュされる, **結果** メッセージ内容に実際の利用額と予算額が含まれている

---

### ユーザーストーリー 2 - 予測額の超過検知 (優先度: P1)

システム管理者として、AWS利用額の予測値が設定した予算（1000円）を超えそうな場合に事前に通知を受け取りたい。これにより、実際の超過が発生する前に対策を講じることができる。

**この優先度の理由**: 予測ベースのアラートは予防的な対応を可能にし、実際の超過を未然に防ぐことができるため最優先。P1としてUS1と同時に実装することで、包括的なコスト監視を実現する。

**独立テスト**: AWS Budgetの予測機能を使用し、月末までの予測額が予算を超える見込みの場合にスマホアプリに通知が届くことをテスト可能。

**受け入れシナリオ**:

1. **前提** AWS予算が1000円で設定されている, **実行** 月末までの予測利用額が1000円を超える見込み, **結果** スマホアプリに予測超過の通知が届く
2. **前提** 予測額アラートが設定されている, **実行** 予測額が予算内に収まる見込み, **結果** 通知は送信されない
3. **前提** 予測額が予算を超える見込み, **実行** SNSトピックにメッセージがパブリッシュされる, **結果** メッセージ内容に予測額と予算額が含まれている

---

### ユーザーストーリー 3 - アラート設定の管理 (優先度: P2)

システム管理者として、予算アラートの設定をインフラストラクチャコードで管理したい。これにより、環境の再現性を保ち、設定の変更履歴を追跡できる。

**この優先度の理由**: インフラストラクチャコード化は重要だが、アラート機能自体が優先されるため、P2とする。ただし、初回実装時にコード化することで後続の保守性が向上する。

**独立テスト**: CloudFormationまたはCDKコードをデプロイし、AWSコンソールで予算とアラート設定が正しく作成されることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提** インフラストラクチャコードを変更する, **実行** デプロイを実行する, **結果** AWS予算設定が更新される
2. **前提** インフラストラクチャコードで予算額を変更する, **実行** デプロイを実行する, **結果** 既存の予算が新しい金額で更新される
3. **前提** インフラストラクチャコードにSNSトピック設定が含まれる, **実行** デプロイを実行する, **結果** SNSトピックとサブスクリプションが作成される

---

### エッジケース

- 複数の環境（dev, staging）で異なる予算を設定する場合は？
  → 環境変数またはパラメータで予算額を制御し、環境ごとに適切な値を設定する。

- 月の途中でデプロイした場合、予算期間はどうなるか？
  → AWS Budgetは月単位で動作するため、デプロイ月から予算が適用される。過去の利用額には遡及しない。

- SNSトピックへの通知が失敗した場合は？
  → AWS SNSは自動的にリトライを行うが、永続的な失敗の場合はCloudWatch Logsで確認可能。スマホアプリ側のエンドポイント設定を確認する必要がある。

- 予算を削除した場合、過去のアラート履歴はどうなるか？
  → AWS Budgetを削除しても、CloudWatch LogsやSNSの履歴は保持される。ただし、新しいアラートは送信されなくなる。

- 実利用額と予測額の両方が同時に予算を超えた場合は？
  → 両方のアラートが独立して送信される。アプリ側で重複通知を処理する必要がある。

- スマホアプリのエンドポイントが変更された場合は？
  → SNSサブスクリプションを更新する必要がある。インフラストラクチャコードで管理する場合は、コードを更新してデプロイする。

## 要件 *(mandatory)*

### 機能要件

- **FR-001**: システムはAWS Budgetを使用して月次予算1000円を設定しなければならない
- **FR-002**: 実際の利用額が予算（1000円）を超えた場合、SNSトピックに通知を送信しなければならない
- **FR-003**: 予測利用額が予算（1000円）を超える見込みの場合、SNSトピックに通知を送信しなければならない
- **FR-004**: 実利用額のアラート閾値は100%（1000円）に設定しなければならない
- **FR-005**: 予測額のアラート閾値は100%（1000円）に設定しなければならない
- **FR-006**: SNSトピックはスマホアプリへの通知配信をサポートしなければならない
- **FR-007**: アラート設定はCloudFormationまたはAWS CDKで管理されなければならない
- **FR-008**: dev環境とstaging環境で独立した予算とアラートを設定しなければならない
- **FR-009**: SNSトピックは適切なアクセス権限を持ち、AWS Budgetからのメッセージ送信を許可しなければならない
- **FR-010**: 予算期間は月次（MONTHLY）でなければならない
- **FR-011**: アラート通知には利用額、予算額、アカウント情報が含まれなければならない
- **FR-012**: コスト最適化のため、CloudWatchアラームは使用せず、AWS Budgetの標準機能のみを使用しなければならない

### 主要エンティティ

- **Budget（予算）**: AWS利用額の上限を定義するエンティティ
  - budgetName: 予算の名前（例: "attendance-kit-dev-monthly-budget"）
  - budgetLimit: 予算額（1000円）
  - timeUnit: 期間単位（MONTHLY）
  - budgetType: 予算タイプ（COST）

- **Alert（アラート）**: 予算超過を検知する条件とアクション
  - alertType: アラートタイプ（ACTUAL または FORECASTED）
  - threshold: 閾値（100%）
  - notificationTarget: 通知先（SNS Topic ARN）

- **SNS Topic**: 通知配信のためのメッセージングトピック
  - topicName: トピック名（例: "attendance-kit-cost-alerts"）
  - subscribers: サブスクライバー（初期実装: メールアドレス、将来: モバイルアプリエンドポイント）
  - protocol: プロトコル（初期実装: email、将来拡張: application endpoint for mobile push）
  - 注記: スマホでメール受信することで、初期段階でもモバイル通知の要件を満たす

## 成功基準 *(mandatory)*

### 測定可能な成果

- **SC-001**: 利用額が1000円を超えてから5分以内にスマホアプリに通知が届く
- **SC-002**: 予測額が1000円を超える見込みとなった時点から5分以内にスマホアプリに通知が届く
- **SC-003**: インフラストラクチャコードのデプロイから10分以内に予算とアラート設定が有効になる
- **SC-004**: アラート通知の成功率が95%以上である（SNSの配信成功率）
- **SC-005**: 月次コストレポートで、予算管理機能自体の追加コストが無料枠内に収まる
- **SC-006**: CloudFormation/CDKコードの変更により、5分以内に予算設定を更新できる

## 関連ドキュメント

### 開発ガイドライン
- [Agent開発ガイドライン](../../.github/agents/AGENTS.md) - Spec-Kitワークフロー、言語ポリシー、コミット規約

### プロジェクト憲法
- [プロジェクト憲法](../../memory/constitution.md) - プロジェクトの原則とガイドライン

### 技術仕様
- [実装計画](./plan.md) - 技術アーキテクチャと実装詳細
- [実装タスク](./tasks.md) - タスク分解と依存関係
